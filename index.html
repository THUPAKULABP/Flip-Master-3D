<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipMaster Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root[data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-gradient: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            --bg-panel: rgba(30, 41, 59, 0.95);
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --accent: #38bdf8;
            --border: rgba(148, 163, 184, 0.2);
            --shadow: rgba(0,0,0,0.6);
        }
        :root[data-theme="day"] {
            --bg-main: #f8fafc;
            --bg-gradient: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%);
            --bg-panel: rgba(255, 255, 255, 0.95);
            --text-main: #0f172a;
            --text-sub: #64748b;
            --accent: #0284c7;
            --border: rgba(0,0,0,0.1);
            --shadow: rgba(0,0,0,0.15);
        }
        :root[data-theme="dusty"] {
            --bg-main: #e6dac3;
            --bg-gradient: radial-gradient(circle at center, #f5eadd 0%, #e6dac3 100%);
            --bg-panel: rgba(230, 218, 195, 0.95);
            --text-main: #433422;
            --text-sub: #786550;
            --accent: #a0522d;
            --border: rgba(120, 101, 80, 0.3);
            --shadow: rgba(67, 52, 34, 0.25);
        }

        /* MOBILE BASICS */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; 
            overflow: hidden; 
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: color 0.4s ease;
        }

        .glass-panel {
            background-color: var(--bg-panel);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        /* Book wrapper interactions */
        .book-wrapper { 
            box-shadow: 0 10px 30px -10px var(--shadow); 
            transition: box-shadow 0.3s ease;
        }

        .page-content {
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Scrollbars */
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }

        .loader { border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-bg { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        
        input, select, button { font-size: 16px !important; }

        /* Custom Select Style for Header */
        .custom-select {
            background-color: var(--bg-main);
            color: var(--text-sub);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.3rem 0.5rem;
            font-size: 0.75rem !important;
            outline: none;
            cursor: pointer;
            appearance: none; /* Hide default arrow */
            text-align: center;
        }
        .custom-select:hover { border-color: var(--accent); color: var(--text-main); }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col relative overflow-hidden">

    <header class="h-14 flex items-center justify-between px-2 sm:px-4 z-[60] relative glass-panel border-b-0 border-b border-[var(--border)] shadow-sm shrink-0">
        
        <div class="flex items-center gap-2 sm:gap-3">
            <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-[var(--border)] text-[var(--text-sub)] hover:text-[var(--text-main)] transition">
                <i class="fa-solid fa-bars fa-lg"></i>
            </button>
            <div class="flex items-center gap-2 select-none">
                <div class="w-7 h-7 rounded bg-[var(--accent)] flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-book-open text-xs"></i>
                </div>
                <h1 class="font-bold text-base tracking-wide hidden sm:block">Flip<span style="color: var(--accent)">Master</span></h1>
            </div>
        </div>

        <div class="flex items-center gap-2">
            
            <div class="relative group" title="Page Layout">
                <select id="viewModeSelect" onchange="changeViewMode(this.value)" class="custom-select w-20 sm:w-24">
                    <option value="auto">Auto Fit</option>
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                    <option value="square">Square</option>
                </select>
                <div class="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none text-[var(--text-sub)] text-[10px]">
                    <i class="fa-solid fa-caret-down"></i>
                </div>
            </div>

            <button onclick="cycleTheme()" id="themeBtn" class="p-2 rounded-lg border border-[var(--border)] bg-[var(--bg-main)]/50 text-[var(--text-sub)] hover:text-[var(--text-main)] transition" title="Change Theme">
                <i class="fa-solid fa-circle-half-stroke"></i>
            </button>

            <button onclick="toggleFullScreen()" id="fsBtn" class="p-2 rounded-lg border border-[var(--border)] bg-[var(--bg-main)]/50 text-[var(--text-sub)] hover:text-[var(--text-main)] transition" title="Full Screen">
                <i class="fa-solid fa-expand"></i>
            </button>

            <button onclick="toggleUrlModal(true)" class="p-2 rounded-lg border border-[var(--border)] bg-[var(--bg-main)]/50 text-[var(--text-sub)] hover:text-[var(--text-main)]" title="Load URL">
                <i class="fa-solid fa-link"></i>
            </button>
            
            <label class="cursor-pointer bg-[var(--accent)] hover:brightness-110 text-white p-2 sm:px-4 sm:py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <span class="hidden sm:inline text-sm">Upload</span>
                <input type="file" id="inpFile" accept="application/pdf" class="hidden">
            </label>
        </div>
    </header>

    <aside id="sidebar" class="sidebar fixed top-14 left-0 h-[calc(100dvh-3.5rem)] w-64 glass-panel border-r border-[var(--border)] transform -translate-x-full z-[70] flex flex-col">
        <div class="p-4 border-b border-[var(--border)]">
            <h2 class="font-bold mb-3 text-[var(--text-main)] text-xs uppercase tracking-wider opacity-80">Chapters</h2>
            <div class="flex rounded-lg overflow-hidden border border-[var(--border)] focus-within:border-[var(--accent)] transition">
                <input type="number" id="jumpInput" placeholder="Page" class="w-full bg-[var(--bg-main)] text-[var(--text-main)] px-3 py-2 outline-none text-sm">
                <button id="jumpBtn" class="bg-[var(--bg-panel)] hover:bg-[var(--accent)] hover:text-white px-3 py-2 text-xs font-bold border-l border-[var(--border)]">GO</button>
            </div>
        </div>
        <div id="toc-container" class="flex-1 overflow-y-auto p-2 sidebar-scroll"></div>
    </aside>
    <div id="backdrop" class="fixed inset-0 bg-black/60 z-[65] hidden backdrop-blur-sm"></div>

    <main id="main-area" class="flex-1 relative flex items-center justify-center overflow-hidden w-full perspective-1000 h-full touch-none">
        
        <div id="fit-badge" class="absolute top-2 right-2 z-30 opacity-50 hover:opacity-100 transition hidden">
             <div class="bg-[var(--bg-panel)] text-[var(--text-sub)] text-[10px] px-2 py-1 rounded border border-[var(--border)] pointer-events-none">
                <i class="fa-solid fa-ruler-combined"></i> <span id="fit-text">Auto Fit</span>
            </div>
        </div>

        <div id="intro-state" class="text-center p-6 transition-opacity duration-500 max-w-sm mx-auto z-10">
            <div class="inline-block p-6 rounded-full bg-[var(--bg-panel)] mb-4 border border-[var(--border)] shadow-2xl">
                <i class="fa-solid fa-book-open-reader text-5xl" style="color: var(--accent)"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">FlipMaster</h2>
            <p class="text-[var(--text-sub)] text-sm">
                Optimized for Mobile Learning.<br>Upload or Paste Link.
            </p>
        </div>

        <div id="loader" class="hidden absolute inset-0 z-[80] bg-black/90 flex flex-col items-center justify-center">
            <div class="loader rounded-full border-4 border-t-4 h-10 w-10 mb-4"></div>
            <p id="loading-text" class="text-white font-mono animate-pulse text-xs tracking-widest uppercase">Loading...</p>
        </div>

        <div id="zoom-wrapper" class="transition-transform duration-100 ease-out origin-center w-full h-full flex items-center justify-center will-change-transform">
            <div id="book-container" class="hidden relative book-wrapper"></div>
        </div>
    </main>

    <div id="controls" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 glass-panel rounded-full px-4 py-2 flex items-center gap-3 shadow-2xl z-[60] border border-[var(--border)] w-auto max-w-[95vw] whitespace-nowrap">
        
        <button id="zoomOut" class="w-8 h-8 rounded-full bg-[var(--bg-main)] text-[var(--text-main)] border border-[var(--border)] flex items-center justify-center hover:bg-[var(--accent)] active:scale-90 transition">
            <i class="fa-solid fa-minus"></i>
        </button>

        <button id="prevBtn" class="w-8 h-8 rounded-full bg-[var(--bg-main)] text-[var(--text-main)] border border-[var(--border)] flex items-center justify-center hover:bg-[var(--accent)] active:scale-90 transition"><i class="fa-solid fa-chevron-left"></i></button>
        
        <span class="font-mono text-xs text-[var(--text-main)] font-bold select-none min-w-[50px] text-center">
            <span id="currentPage">0</span>/<span id="totalPages">0</span>
        </span>
        
        <button id="nextBtn" class="w-8 h-8 rounded-full bg-[var(--bg-main)] text-[var(--text-main)] border border-[var(--border)] flex items-center justify-center hover:bg-[var(--accent)] active:scale-90 transition"><i class="fa-solid fa-chevron-right"></i></button>
        
        <button id="zoomIn" class="w-8 h-8 rounded-full bg-[var(--bg-main)] text-[var(--text-main)] border border-[var(--border)] flex items-center justify-center hover:bg-[var(--accent)] active:scale-90 transition">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="w-px h-6 bg-[var(--border)] mx-1"></div>
        
        <button id="zoomReset" class="text-[var(--text-sub)] hover:text-[var(--accent)] text-xs" title="Reset View"><i class="fa-solid fa-compress"></i></button>
    </div>

    <div id="urlModal" class="fixed inset-0 z-[100] modal-bg hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl shadow-2xl p-5">
            <h3 class="font-bold text-lg mb-3 text-[var(--text-main)]">Load PDF URL</h3>
            <input type="text" id="urlInput" placeholder="https://..." class="w-full bg-[var(--bg-main)] text-[var(--text-main)] border border-[var(--border)] rounded-lg p-3 outline-none text-sm mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="toggleUrlModal(false)" class="text-[var(--text-sub)] px-3 py-2 text-sm">Cancel</button>
                <button id="btnFetchUrl" class="bg-[var(--accent)] text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg">Open</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="fixed inset-0 z-[100] modal-bg hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl shadow-2xl p-5 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-[var(--border)] pb-2">
                <h3 class="font-bold text-lg text-[var(--text-main)]">Share Material</h3>
                <button onclick="toggleShareModal(false)" class="text-[var(--text-sub)]"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            
            <div class="overflow-y-auto space-y-4">
                <div id="shareUrlMode" class="hidden space-y-4">
                    <p class="text-[var(--text-sub)] text-xs">Share this link with students. It opens directly to this PDF.</p>
                    <div class="flex gap-2">
                        <input type="text" id="shareDirectLink" readonly class="w-full bg-[var(--bg-main)] text-[var(--text-main)] border border-[var(--border)] rounded p-2 text-xs font-mono">
                        <button onclick="copyToClipboard('shareDirectLink')" class="bg-[var(--accent)] text-white px-3 rounded text-xs">Copy</button>
                    </div>
                </div>

                <div id="shareFileMode" class="hidden">
                    <div class="bg-yellow-500/10 border border-yellow-500/30 p-3 rounded-lg text-yellow-400 text-xs mb-3">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Local File
                    </div>
                    <p class="text-[var(--text-sub)] text-sm mb-3">To share this file online, upload it to a cloud drive (Google Drive, Dropbox) first, then use the "Load URL" feature.</p>
                    <button onclick="downloadStandalone()" class="w-full bg-[var(--accent)] text-white py-2 rounded-lg text-sm font-bold shadow-lg">Download Offline HTML</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const state = {
            pdfDoc: null,
            pageFlip: null,
            fileBase64: null,
            currentUrl: null,
            loadType: null,
            isSidebarOpen: false,
            // Zoom State
            scale: 1.0,
            panX: 0,
            panY: 0,
            isDragging: false,
            startPanX: 0,
            startPanY: 0,
            initialPinchDistance: null,
            initialScale: 1.0,
            // New View Mode
            viewMode: 'auto' // 'auto', 'portrait', 'landscape', 'square'
        };

        const themes = ['dark', 'day', 'dusty'];
        let currentThemeIdx = 0;

        const el = (id) => document.getElementById(id);
        function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); }
        function cycleTheme() {
            currentThemeIdx = (currentThemeIdx + 1) % themes.length;
            setTheme(themes[currentThemeIdx]);
        }

        // --- NEW FEATURES: FULL SCREEN & VIEW MODES ---

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.log("Fullscreen not supported or allowed");
                });
                el('fsBtn').innerHTML = '<i class="fa-solid fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    el('fsBtn').innerHTML = '<i class="fa-solid fa-expand"></i>';
                }
            }
        }

        function changeViewMode(mode) {
            state.viewMode = mode;
            el('fit-badge').classList.remove('hidden');
            
            const labels = { 'auto': 'Auto Fit', 'portrait': 'Portrait', 'landscape': 'Landscape', 'square': 'Square' };
            el('fit-text').textContent = labels[mode];

            // Trigger re-render of layout
            if(state.pdfDoc) {
                // Manually trigger the resize event logic
                window.dispatchEvent(new Event('resize'));
            }
        }

        // --- HELPERS ---
        function isMobile() { return window.innerWidth < 768; }
        
        function getOptimalBookDimensions() {
            // Get available space (subtracting headers/margins)
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            // Margins for UI
            const marginX = isMobile() ? 20 : 60;
            const marginY = isMobile() ? 160 : 120; // Space for Header + Controls

            const maxW = w - marginX;
            const maxH = h - marginY;

            let finalW, finalH, finalMode;

            // 1. Calculate based on View Mode
            if (state.viewMode === 'auto') {
                if (isMobile()) {
                    // Mobile Auto: Portrait if vertical screen, Landscape if horizontal
                    if (h > w) {
                        finalW = maxW;
                        finalH = maxH;
                        finalMode = 'portrait';
                    } else {
                        finalW = maxW / 2; // Split for spread
                        finalH = maxH;
                        finalMode = 'landscape';
                    }
                } else {
                    // Desktop Auto: Landscape spread
                    finalW = 550;
                    finalH = 750;
                    finalMode = 'landscape';
                }
            } else if (state.viewMode === 'portrait') {
                // Force Portrait: Ratio approx 1 : 1.41
                const ratio = 1.41;
                // Try fitting by height first
                finalH = maxH;
                finalW = finalH / ratio;
                // If too wide, fit by width
                if (finalW > maxW) {
                    finalW = maxW;
                    finalH = finalW * ratio;
                }
                finalMode = 'portrait'; // Single page
            } else if (state.viewMode === 'landscape') {
                // Force Landscape: Ratio approx 1.41 : 1
                const ratio = 1.41; // Width is larger
                // For flipbook, this is the width of ONE page. 
                // In landscape mode, we usually see 2 pages. 
                // Let's assume user wants a wider look.
                
                finalW = maxW / (isMobile() ? 1 : 2); // On mobile landscape usually means 1 wide page in this context or small spread? 
                // Let's stick to standard spread logic for "Landscape" mode setting
                if(isMobile()) finalW = (w - 40) / 2; 
                else finalW = 550;

                finalH = finalW * 1.41; // Standard A4 ratio
                if(finalH > maxH) {
                    finalH = maxH;
                    finalW = finalH / 1.41;
                }
                finalMode = 'landscape';
            } else if (state.viewMode === 'square') {
                // Square 1:1
                const size = Math.min(maxW, maxH);
                finalW = size;
                finalH = size;
                finalMode = 'portrait'; // Treat as single page technically to avoid weird spreads
            }

            return { width: finalW, height: finalH, mode: finalMode };
        }

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const pdfUrl = params.get('pdf');
            if(pdfUrl) {
                el('urlInput').value = pdfUrl;
                el('btnFetchUrl').click();
                document.querySelector('header').style.display = 'none';
                el('sidebar').style.top = '0';
                el('sidebar').style.height = '100dvh';
            }
            setupTouchGestures();
        });

        // --- FILE & URL LOADING ---
        el('inpFile').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                state.loadType = 'file';
                state.currentUrl = null;
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => { state.fileBase64 = reader.result; };
                reader.readAsDataURL(file);
                const buffer = await file.arrayBuffer();
                loadDocument(new Uint8Array(buffer));
            }
        });

        el('btnFetchUrl').addEventListener('click', async () => {
            const url = el('urlInput').value.trim();
            if(!url) return;
            toggleUrlModal(false);
            toggleLoader(true, "Downloading...");
            try {
                const res = await fetch(url);
                if(!res.ok) throw new Error("CORS Error");
                const blob = await res.blob();
                state.loadType = 'url';
                state.currentUrl = url;
                const buffer = await blob.arrayBuffer();
                loadDocument(new Uint8Array(buffer));
            } catch(e) {
                toggleLoader(false);
                alert("Could not load URL. \n\nTip: The server must allow CORS. Try a GitHub Raw link or direct file link.");
            }
        });

        // --- CORE PDF LOGIC ---
        async function loadDocument(data) {
            toggleLoader(true, "Processing...");
            el('intro-state').classList.add('hidden');
            if(state.pageFlip) { state.pageFlip.destroy(); state.pageFlip = null; }
            el('book-container').innerHTML = '<div id="book"></div>';

            try {
                state.pdfDoc = await pdfjsLib.getDocument(data).promise;
                el('totalPages').textContent = state.pdfDoc.numPages;
                await renderPages(state.pdfDoc);
                initFlipbook();
                await generateTOC(state.pdfDoc);
                el('book-container').classList.remove('hidden');
                el('controls').classList.remove('hidden');
            } catch(err) {
                alert("Error: " + err.message);
                el('intro-state').classList.remove('hidden');
            } finally {
                toggleLoader(false);
            }
        }

        async function renderPages(pdf) {
            const bookDiv = document.getElementById('book');
            const total = pdf.numPages;
            const renderScale = isMobile() ? 1.5 : 1.5; 

            for(let i = 1; i <= total; i++) {
                el('loading-text').textContent = `Page ${i}/${total}`;
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: renderScale });
                
                const div = document.createElement('div');
                div.className = "page-content shadow-sm bg-white"; 
                
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.cssText = "width: 100%; height: 100%; object-fit: contain;";
                
                const ctx = canvas.getContext('2d');
                await page.render({ canvasContext: ctx, viewport }).promise;
                
                div.appendChild(canvas);
                bookDiv.appendChild(div);
                if(i % 5 === 0) await new Promise(r => setTimeout(r, 0));
            }
        }

        function initFlipbook() {
            const dims = getOptimalBookDimensions();
            const bookElement = document.getElementById('book');
            
            // Logic to determine if we use Portrait (Single Page) mode in the library
            // If user selected Portrait OR Square OR (Auto + Mobile Portrait) -> Use Portrait Mode
            let usePortraitMode = false;
            
            if (state.viewMode === 'portrait' || state.viewMode === 'square') {
                usePortraitMode = true;
            } else if (state.viewMode === 'auto' && isMobile() && window.innerHeight > window.innerWidth) {
                usePortraitMode = true;
            }

            state.pageFlip = new St.PageFlip(bookElement, {
                width: dims.width,
                height: dims.height,
                maxWidth: 2000,
                maxHeight: 2000,
                showCover: true,
                size: 'fixed',
                usePortrait: usePortraitMode,
                mobileScrollSupport: false, // Disabled for custom gestures
                startPage: 0
            });

            state.pageFlip.loadFromHTML(document.querySelectorAll(".page-content"));
            state.pageFlip.on('flip', (e) => {
                el('currentPage').textContent = e.data + 1;
            });
        }

        // --- ZOOM & TOUCH LOGIC ---
        function updateTransform() {
            const wrapper = el('zoom-wrapper');
            if(state.scale <= 1) { state.panX = 0; state.panY = 0; }
            wrapper.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.scale})`;
        }

        function setZoom(newScale) {
            state.scale = Math.max(1, Math.min(newScale, 4));
            updateTransform();
        }

        el('zoomIn').onclick = () => setZoom(state.scale + 0.5);
        el('zoomOut').onclick = () => setZoom(state.scale - 0.5);
        el('zoomReset').onclick = () => { 
            state.scale = 1; 
            state.panX = 0; 
            state.panY = 0; 
            updateTransform(); 
        };

        function setupTouchGestures() {
            const area = el('main-area');
            area.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    state.initialPinchDistance = getDistance(e.touches);
                    state.initialScale = state.scale;
                } else if (e.touches.length === 1 && state.scale > 1) {
                    state.isDragging = true;
                    state.startPanX = e.touches[0].clientX - state.panX;
                    state.startPanY = e.touches[0].clientY - state.panY;
                }
            });
            area.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches);
                    if (state.initialPinchDistance) {
                        const zoomFactor = currentDistance / state.initialPinchDistance;
                        setZoom(state.initialScale * zoomFactor);
                    }
                } else if (e.touches.length === 1 && state.scale > 1 && state.isDragging) {
                    e.preventDefault();
                    state.panX = e.touches[0].clientX - state.startPanX;
                    state.panY = e.touches[0].clientY - state.startPanY;
                    updateTransform();
                }
            });
            area.addEventListener('touchend', (e) => {
                state.isDragging = false;
                if (e.touches.length < 2) { state.initialPinchDistance = null; }
            });
        }

        function getDistance(touches) {
            return Math.hypot(
                touches[0].clientX - touches[1].clientX,
                touches[0].clientY - touches[1].clientY
            );
        }

        // --- RESIZE / RE-LAYOUT ---
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if(!state.pdfDoc) return;
                const currentPage = state.pageFlip ? state.pageFlip.getCurrentPageIndex() : 0;
                if(state.pageFlip) state.pageFlip.destroy();
                el('book-container').innerHTML = '<div id="book"></div>';
                
                toggleLoader(true, "Adjusting Layout...");
                setTimeout(async () => {
                    await renderPages(state.pdfDoc);
                    initFlipbook();
                    try { state.pageFlip.flip(currentPage, false); } catch(e){}
                    toggleLoader(false);
                }, 100);
            }, 500);
        });

        // --- SHARE & UI HELPERS ---
        el('btnShare').onclick = () => {
            if(!state.pdfDoc) { alert("Load PDF first."); return; }
            toggleShareModal(true);
            
            if(state.loadType === 'url') {
                el('shareUrlMode').classList.remove('hidden');
                el('shareFileMode').classList.add('hidden');
                const baseUrl = window.location.href.split('?')[0];
                const link = `${baseUrl}?pdf=${encodeURIComponent(state.currentUrl)}`;
                el('shareDirectLink').value = link;
            } else {
                el('shareUrlMode').classList.add('hidden');
                el('shareFileMode').classList.remove('hidden');
            }
        };

        window.downloadStandalone = () => {
             const injection = `
            <script>
                const autoLoadData = "${state.fileBase64}";
                function dataURItoUint8Array(dataURI) {
                    const byteString = atob(dataURI.split(',')[1]);
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) { ia[i] = byteString.charCodeAt(i); }
                    return ia;
                }
                window.addEventListener('load', () => {
                    document.getElementById('intro-state').style.display = 'none';
                    const h = document.querySelector('header'); if(h) h.style.display = 'none';
                    const pdfData = dataURItoUint8Array(autoLoadData);
                    loadDocument(pdfData);
                });
            <\/script>`;
            const html = document.documentElement.outerHTML.replace('</body>', injection + '</body>');
            const blob = new Blob([html], {type: "text/html"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "FlipBook-Viewer.html";
            link.click();
        }

        function toggleUrlModal(show) { el('urlModal').style.display = show ? 'flex' : 'none'; }
        function toggleShareModal(show) { el('shareModal').style.display = show ? 'flex' : 'none'; }
        function toggleLoader(show, text) { 
            const l = el('loader');
            if(show) { l.classList.remove('hidden'); el('loading-text').textContent = text; }
            else l.classList.add('hidden'); 
        }
        function copyToClipboard(id) {
            el(id).select(); navigator.clipboard.writeText(el(id).value).then(()=>alert("Copied!"));
        }

        el('toggleSidebar').onclick = () => {
            state.isSidebarOpen = !state.isSidebarOpen;
            el('sidebar').classList.toggle('-translate-x-full', !state.isSidebarOpen);
            el('backdrop').classList.toggle('hidden', !state.isSidebarOpen);
        }
        el('backdrop').onclick = el('toggleSidebar').onclick;
        
        el('prevBtn').onclick = () => state.pageFlip.flipPrev();
        el('nextBtn').onclick = () => state.pageFlip.flipNext();

        async function generateTOC(pdf) {
            const container = el('toc-container');
            container.innerHTML = "";
            const outline = await pdf.getOutline();
            if(!outline) { container.innerHTML = `<div class="text-center mt-5 text-[var(--text-sub)] text-xs">No chapters found.</div>`; return; }
            const ul = document.createElement('ul');
            ul.className = "space-y-1";
            for(const item of outline) {
                const li = document.createElement('li');
                const div = document.createElement('div');
                div.className = "p-2 rounded cursor-pointer text-sm text-[var(--text-sub)] hover:bg-[var(--accent)] hover:text-white truncate";
                div.textContent = item.title;
                div.onclick = async () => {
                    if(item.dest) {
                        const dest = typeof item.dest === 'string' ? await pdf.getDestination(item.dest) : item.dest;
                        if(dest) {
                            const index = await pdf.getPageIndex(dest[0]);
                            state.pageFlip.flip(index);
                            if(isMobile()) el('toggleSidebar').click();
                        }
                    }
                };
                li.appendChild(div);
                ul.appendChild(li);
            }
            container.appendChild(ul);
        }
    </script>
</body>
</html>
