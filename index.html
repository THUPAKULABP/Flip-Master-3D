<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>FlipMaster Mobile Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <style>
        /* --- THEMES --- */
        :root[data-theme="dark"] {
            --bg-main: #0f172a; --bg-panel: rgba(15, 23, 42, 0.95);
            --text: #f1f5f9; --accent: #38bdf8; --border: rgba(255,255,255,0.1);
        }
        :root[data-theme="day"] {
            --bg-main: #f1f5f9; --bg-panel: rgba(255, 255, 255, 0.95);
            --text: #0f172a; --accent: #0284c7; --border: rgba(0,0,0,0.1);
        }
        :root[data-theme="dusty"] {
            --bg-main: #e8dcca; /* Sepia Background */
            --bg-panel: rgba(232, 220, 202, 0.95);
            --text: #5c4a3d; /* Brown Text */
            --accent: #8b5a2b; /* Leather Color */
            --border: rgba(139, 90, 43, 0.2);
        }

        /* --- LAYOUT --- */
        body {
            background-color: var(--bg-main);
            color: var(--text);
            font-family: sans-serif;
            overflow: hidden; /* Prevent body scroll, we handle book scroll */
            touch-action: none; /* Disable default browser gestures to handle pinch manually */
            transition: background 0.3s ease;
        }

        .glass {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
        }

        /* --- BOOK CONTAINER & ZOOM --- */
        /* This wrapper handles the panning/zooming transform */
        #zoom-viewport {
            width: 100%;
            height: 100%;
            overflow: visible;
            display: flex;
            justify-content: center;
            align-items: center;
            transform-origin: center center;
            touch-action: none;
        }

        .page-content {
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        /* --- UTILS --- */
        .loader { border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Hide Scrollbars */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Mobile Input Reset */
        input { font-size: 16px; } 
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col relative">

    <header class="h-12 flex items-center justify-between px-3 z-50 glass shrink-0 relative">
        <div class="flex items-center gap-2">
            <button onclick="cycleTheme()" class="w-8 h-8 rounded bg-[var(--bg-main)] border border-[var(--border)] text-[var(--accent)] flex items-center justify-center">
                <i class="fa-solid fa-palette"></i>
            </button>
            <h1 class="font-bold text-sm tracking-wide truncate">Flip<span style="color: var(--accent)">Master</span></h1>
        </div>

        <div class="flex items-center gap-2">
            <label class="bg-[var(--accent)] text-white px-3 py-1.5 rounded text-xs font-bold shadow flex items-center gap-1 cursor-pointer active:scale-95 transition">
                <i class="fa-solid fa-upload"></i> <span class="hidden sm:inline">Upload</span>
                <input type="file" id="inpFile" accept="application/pdf" class="hidden">
            </label>
            <button onclick="toggleUrlModal(true)" class="bg-[var(--bg-main)] text-[var(--text)] border border-[var(--border)] px-3 py-1.5 rounded text-xs font-bold">URL</button>
        </div>
    </header>

    <main id="main-container" class="flex-1 relative overflow-hidden w-full bg-[var(--bg-main)]">
        
        <div id="intro-state" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10">
            <div class="p-4 rounded-full bg-[var(--bg-panel)] mb-4 shadow-lg border border-[var(--border)]">
                <i class="fa-solid fa-book-open text-4xl" style="color: var(--accent)"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">Mobile Ready</h2>
            <p class="text-xs opacity-70 max-w-[250px]">Upload a PDF. Use two fingers to pinch & zoom.</p>
        </div>

        <div id="loader" class="hidden absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center">
            <div class="loader rounded-full border-4 border-t-4 h-10 w-10 mb-3"></div>
            <p id="loading-text" class="text-white text-xs font-mono uppercase tracking-widest">Loading...</p>
        </div>

        <div id="zoom-viewport">
            <div id="book"></div>
        </div>

    </main>

    <div id="controls" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 glass rounded-full px-4 py-2 flex items-center gap-3 shadow-2xl z-50 w-[90%] max-w-md justify-between">
        
        <div class="flex items-center gap-2">
            <button id="prevBtn" class="w-8 h-8 rounded-full bg-[var(--bg-main)] border border-[var(--border)] flex items-center justify-center active:bg-[var(--accent)] active:text-white"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-xs font-mono font-bold w-12 text-center"><span id="currPage">0</span>/<span id="totalPage">0</span></span>
            <button id="nextBtn" class="w-8 h-8 rounded-full bg-[var(--bg-main)] border border-[var(--border)] flex items-center justify-center active:bg-[var(--accent)] active:text-white"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="h-6 w-px bg-[var(--border)]"></div>

        <div class="flex items-center gap-3">
            <button onclick="manualZoom(0.8)" class="text-[var(--text)] active:text-[var(--accent)]"><i class="fa-solid fa-minus"></i></button>
            <button onclick="resetZoom()" class="text-xs bg-[var(--bg-main)] border border-[var(--border)] px-2 py-1 rounded">Reset</button>
            <button onclick="manualZoom(1.2)" class="text-[var(--text)] active:text-[var(--accent)]"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <div id="urlModal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm rounded-xl p-5 shadow-2xl">
            <h3 class="font-bold mb-3">Load URL</h3>
            <input type="text" id="urlInput" placeholder="https://example.com/file.pdf" class="w-full bg-[var(--bg-main)] text-[var(--text)] border border-[var(--border)] rounded p-3 text-sm mb-3 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="toggleUrlModal(false)" class="px-3 py-2 text-xs opacity-70">Cancel</button>
                <button id="btnFetchUrl" class="bg-[var(--accent)] text-white px-4 py-2 rounded text-xs font-bold">Load</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const state = {
            pdf: null,
            flipbook: null,
            scale: 1, // Visual Zoom Scale
            pan: { x: 0, y: 0 },
            isPortrait: window.innerHeight > window.innerWidth,
            currentTheme: 0
        };

        const themes = ['dark', 'day', 'dusty'];
        const el = (id) => document.getElementById(id);

        // --- THEME LOGIC ---
        function cycleTheme() {
            state.currentTheme = (state.currentTheme + 1) % themes.length;
            document.documentElement.setAttribute('data-theme', themes[state.currentTheme]);
        }

        // --- FILE HANDLING ---
        el('inpFile').addEventListener('change', (e) => {
            if(e.target.files[0]) loadFile(e.target.files[0]);
        });

        el('btnFetchUrl').addEventListener('click', async () => {
            const url = el('urlInput').value.trim();
            if(!url) return;
            toggleUrlModal(false);
            toggleLoader(true, "Downloading...");
            try {
                const res = await fetch(url);
                if(!res.ok) throw new Error("CORS Error");
                const blob = await res.blob();
                loadFile(blob);
            } catch(e) {
                toggleLoader(false);
                alert("Cannot load URL. Try downloading the file first.");
            }
        });

        async function loadFile(blob) {
            toggleLoader(true, "Processing PDF...");
            el('intro-state').classList.add('hidden');
            const buffer = await blob.arrayBuffer();
            
            try {
                state.pdf = await pdfjsLib.getDocument(new Uint8Array(buffer)).promise;
                el('totalPage').textContent = state.pdf.numPages;
                await initBook();
                el('controls').classList.remove('hidden');
                el('controls').classList.add('flex');
            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // --- BOOK INITIALIZATION & RENDERING ---
        async function initBook() {
            if(state.flipbook) state.flipbook.destroy();
            el('book').innerHTML = ''; // Clear container
            
            state.isPortrait = window.innerHeight > window.innerWidth;
            const width = window.innerWidth;
            const height = window.innerHeight - 100; // Subtract header/footer space

            // Mobile Sizing Logic
            const bookWidth = state.isPortrait ? width - 20 : (width / 2) - 20;
            const bookHeight = height;

            // Render pages
            const total = state.pdf.numPages;
            // Lower render scale on mobile for performance
            const renderScale = state.isPortrait ? 1.0 : 1.2; 

            for(let i=1; i<=total; i++) {
                el('loading-text').textContent = `Rendering ${i}/${total}`;
                const page = await state.pdf.getPage(i);
                const viewport = page.getViewport({ scale: renderScale });
                
                const div = document.createElement('div');
                div.className = "page-content";
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = "100%";
                canvas.style.height = "100%";
                canvas.style.objectFit = "contain";
                
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                div.appendChild(canvas);
                el('book').appendChild(div);
                
                // Breath for UI
                if(i % 3 === 0) await new Promise(r => setTimeout(r,0));
            }

            // Init StPageFlip
            const bookEl = el('book');
            state.flipbook = new St.PageFlip(bookEl, {
                width: bookWidth,
                height: bookHeight,
                size: 'fixed',
                // Critical for mobile: Portrait = 1 page, Landscape = 2 pages
                usePortrait: state.isPortrait, 
                startPage: 0,
                showCover: true,
                mobileScrollSupport: false // We handle touch manually
            });

            state.flipbook.loadFromHTML(document.querySelectorAll(".page-content"));
            
            state.flipbook.on('flip', (e) => {
                el('currPage').textContent = e.data + 1;
            });
            
            // Re-apply zoom reset
            resetZoom();
        }

        // --- ROTATION / RESIZE HANDLER ---
        window.addEventListener('resize', () => {
            // Debounce resize
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => {
                if(state.pdf) {
                    toggleLoader(true, "Rotating...");
                    setTimeout(async () => {
                        await initBook();
                        toggleLoader(false);
                    }, 50);
                }
            }, 200);
        });

        // --- ZOOM & TOUCH ENGINE (PINCH TO ZOOM) ---
        const view = el('zoom-viewport');
        let initialDistance = 0;
        let initialScale = 1;

        // Manual Buttons
        window.manualZoom = (factor) => {
            state.scale *= factor;
            // Clamp zoom
            if(state.scale < 1) state.scale = 1;
            if(state.scale > 4) state.scale = 4;
            updateTransform();
        };

        window.resetZoom = () => {
            state.scale = 1;
            state.pan = {x:0, y:0};
            updateTransform();
        };

        function updateTransform() {
            view.style.transform = `scale(${state.scale}) translate(${state.pan.x}px, ${state.pan.y}px)`;
        }

        // Touch Event Listeners for Pinch
        view.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                initialDistance = getDistance(e.touches);
                initialScale = state.scale;
                e.preventDefault(); // Prevent browser zoom
            }
        }, { passive: false });

        view.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                const currentDistance = getDistance(e.touches);
                const diff = currentDistance / initialDistance;
                state.scale = initialScale * diff;
                
                if(state.scale < 1) state.scale = 1;
                if(state.scale > 5) state.scale = 5;
                
                updateTransform();
                e.preventDefault();
            }
        }, { passive: false });

        function getDistance(touches) {
            return Math.hypot(
                touches[0].pageX - touches[1].pageX,
                touches[0].pageY - touches[1].pageY
            );
        }

        // Navigation
        el('prevBtn').onclick = () => state.flipbook.flipPrev();
        el('nextBtn').onclick = () => state.flipbook.flipNext();
        function toggleUrlModal(show) { el('urlModal').style.display = show ? 'flex' : 'none'; }
        function toggleLoader(show, text) { 
            const l = el('loader');
            if(show) { l.classList.remove('hidden'); el('loading-text').textContent = text; }
            else l.classList.add('hidden');
        }

    </script>
</body>
</html>
