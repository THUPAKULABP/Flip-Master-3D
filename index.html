<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>FlipMaster Pro Mobile</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <style>
        /* --- THEMES --- */
        :root[data-theme="dark"] { --bg: #0f172a; --panel: rgba(15, 23, 42, 0.95); --text: #f1f5f9; --accent: #38bdf8; --border: rgba(255,255,255,0.1); }
        :root[data-theme="day"] { --bg: #f1f5f9; --panel: rgba(255, 255, 255, 0.95); --text: #0f172a; --accent: #0284c7; --border: rgba(0,0,0,0.1); }
        :root[data-theme="dusty"] { --bg: #e8dcca; --panel: rgba(232, 220, 202, 0.95); --text: #5c4a3d; --accent: #8b5a2b; --border: rgba(139, 90, 43, 0.2); }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: sans-serif; overflow: hidden; touch-action: none;
            transition: background 0.3s ease; margin: 0; padding: 0;
        }

        .glass { background: var(--panel); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .page-content { background: white; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .loader { border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Zoom Viewport */
        #zoom-viewport {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center;
            transform-origin: center center; touch-action: none;
        }

        /* Fullscreen Helper */
        :fullscreen { background-color: var(--bg); }
        ::backdrop { background-color: var(--bg); }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col relative">

    <header class="h-12 flex items-center justify-between px-3 z-50 glass shrink-0 relative transition-all duration-300" id="main-header">
        <div class="flex items-center gap-2">
            <button onclick="cycleTheme()" class="w-8 h-8 rounded bg-[var(--bg)] border border-[var(--border)] text-[var(--accent)] flex items-center justify-center">
                <i class="fa-solid fa-palette"></i>
            </button>
            <h1 class="font-bold text-sm tracking-wide truncate">Flip<span style="color: var(--accent)">Master</span></h1>
        </div>

        <div class="flex items-center gap-2">
            <label class="bg-[var(--accent)] text-white px-3 py-1.5 rounded text-xs font-bold shadow flex items-center gap-1 cursor-pointer active:scale-95 transition">
                <i class="fa-solid fa-upload"></i> <span class="hidden sm:inline">Upload</span>
                <input type="file" id="inpFile" accept="application/pdf" class="hidden">
            </label>
            <button onclick="toggleUrlModal(true)" class="bg-[var(--bg)] text-[var(--text)] border border-[var(--border)] px-3 py-1.5 rounded text-xs font-bold">URL</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden w-full bg-[var(--bg)]">
        <div id="intro-state" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10">
            <div class="p-4 rounded-full bg-[var(--panel)] mb-4 shadow-lg border border-[var(--border)]">
                <i class="fa-solid fa-book-open text-4xl" style="color: var(--accent)"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">Mobile Ready</h2>
            <p class="text-xs opacity-70">Upload PDF. Rotate for 2-page view.</p>
        </div>

        <div id="loader" class="hidden absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center">
            <div class="loader rounded-full border-4 border-t-4 h-10 w-10 mb-3"></div>
            <p id="loading-text" class="text-white text-xs font-mono uppercase tracking-widest">Loading...</p>
        </div>

        <div id="zoom-viewport">
            <div id="book"></div>
        </div>
    </main>

    <div id="controls" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 glass rounded-full px-4 py-2 flex items-center gap-3 shadow-2xl z-50 w-[95%] max-w-md justify-between transition-all duration-300">
        
        <div class="flex items-center gap-2">
            <button id="prevBtn" class="w-8 h-8 rounded-full bg-[var(--bg)] border border-[var(--border)] flex items-center justify-center active:bg-[var(--accent)] active:text-white"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-xs font-mono font-bold w-12 text-center"><span id="currPage">0</span>/<span id="totalPage">0</span></span>
            <button id="nextBtn" class="w-8 h-8 rounded-full bg-[var(--bg)] border border-[var(--border)] flex items-center justify-center active:bg-[var(--accent)] active:text-white"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="h-6 w-px bg-[var(--border)]"></div>

        <div class="flex items-center gap-3">
            <button onclick="manualZoom(0.8)" class="text-[var(--text)] active:text-[var(--accent)]"><i class="fa-solid fa-minus"></i></button>
            <button onclick="manualZoom(1.2)" class="text-[var(--text)] active:text-[var(--accent)]"><i class="fa-solid fa-plus"></i></button>
            <div class="h-6 w-px bg-[var(--border)]"></div>
            <button onclick="toggleFullScreen()" id="fsBtn" class="text-[var(--text)] active:text-[var(--accent)]" title="Full Screen">
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>
    </div>

    <div id="urlModal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm rounded-xl p-5 shadow-2xl">
            <h3 class="font-bold mb-3">Load URL</h3>
            <input type="text" id="urlInput" placeholder="https://..." class="w-full bg-[var(--bg)] text-[var(--text)] border border-[var(--border)] rounded p-3 text-sm mb-3 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="toggleUrlModal(false)" class="px-3 py-2 text-xs opacity-70">Cancel</button>
                <button id="btnFetchUrl" class="bg-[var(--accent)] text-white px-4 py-2 rounded text-xs font-bold">Load</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const state = {
            pdf: null,
            flipbook: null,
            scale: 1,
            pan: { x: 0, y: 0 },
            currentTheme: 0,
            isRendering: false // Safety flag
        };

        const themes = ['dark', 'day', 'dusty'];
        const el = (id) => document.getElementById(id);
        const isMobile = () => window.innerWidth < 768;

        // --- THEME ---
        function cycleTheme() {
            state.currentTheme = (state.currentTheme + 1) % themes.length;
            document.documentElement.setAttribute('data-theme', themes[state.currentTheme]);
        }

        // --- FULLSCREEN LOGIC ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable fullscreen: ${err.message}`);
                });
                el('fsBtn').innerHTML = '<i class="fa-solid fa-compress"></i>';
                // Optional: Hide header in fullscreen for immersive reading
                // el('main-header').style.display = 'none'; 
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    el('fsBtn').innerHTML = '<i class="fa-solid fa-expand"></i>';
                    // el('main-header').style.display = 'flex';
                }
            }
        }

        // --- LOADERS ---
        el('inpFile').addEventListener('change', (e) => {
            if(e.target.files[0]) loadFile(e.target.files[0]);
        });

        el('btnFetchUrl').addEventListener('click', async () => {
            const url = el('urlInput').value.trim();
            if(!url) return;
            toggleUrlModal(false);
            toggleLoader(true, "Downloading...");
            try {
                const res = await fetch(url);
                if(!res.ok) throw new Error("CORS Error");
                const blob = await res.blob();
                loadFile(blob);
            } catch(e) {
                toggleLoader(false);
                alert("Cannot load URL. Try downloading file first.");
            }
        });

        async function loadFile(blob) {
            toggleLoader(true, "Processing...");
            el('intro-state').classList.add('hidden');
            const buffer = await blob.arrayBuffer();
            try {
                state.pdf = await pdfjsLib.getDocument(new Uint8Array(buffer)).promise;
                el('totalPage').textContent = state.pdf.numPages;
                await initBook();
                el('controls').classList.remove('hidden');
                el('controls').classList.add('flex');
            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // --- RENDER ENGINE ---
        async function initBook() {
            if(state.isRendering) return; // Prevent double triggers
            state.isRendering = true;

            if(state.flipbook) state.flipbook.destroy();
            el('book').innerHTML = ''; 

            const width = window.innerWidth;
            const height = window.innerHeight - 100; // Safe area
            const isPortrait = height > width;

            // Smart Dimensions
            let bookW, bookH;
            if (isMobile()) {
                bookW = isPortrait ? width - 10 : (width / 2) - 10;
                bookH = height;
            } else {
                bookW = 500; bookH = 700;
            }

            const total = state.pdf.numPages;
            const renderScale = isMobile() ? 1.0 : 1.5; 

            // Render pages to DOM
            for(let i=1; i<=total; i++) {
                el('loading-text').textContent = `Drawing ${i}/${total}`;
                const page = await state.pdf.getPage(i);
                const viewport = page.getViewport({ scale: renderScale });
                
                const div = document.createElement('div');
                div.className = "page-content";
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.cssText = "width: 100%; height: 100%; object-fit: contain;";
                
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                div.appendChild(canvas);
                el('book').appendChild(div);
            }

            // Init 3D Engine
            const bookEl = el('book');
            state.flipbook = new St.PageFlip(bookEl, {
                width: bookW,
                height: bookH,
                size: 'fixed',
                usePortrait: isPortrait, 
                startPage: 0,
                showCover: true,
                mobileScrollSupport: false 
            });

            state.flipbook.loadFromHTML(document.querySelectorAll(".page-content"));
            state.flipbook.on('flip', (e) => el('currPage').textContent = e.data + 1);
            
            // Reset View
            state.scale = 1;
            updateTransform();
            state.isRendering = false;
        }

        // --- ROTATION FIX (ANTI-FREEZE) ---
        let resizeTimer;
        window.addEventListener('resize', () => {
            // 1. Clear previous timer to prevent multiple triggers
            clearTimeout(resizeTimer);
            
            // 2. Set delay to 500ms to allow screen rotation animation to finish completely
            resizeTimer = setTimeout(async () => {
                if(!state.pdf) return;

                // 3. Force Loader ON
                toggleLoader(true, "Rotating...");

                // 4. Safety Block
                try {
                    const currentPage = state.flipbook ? state.flipbook.getCurrentPageIndex() : 0;
                    
                    // Re-run init
                    await initBook();

                    // Restore page
                    if(state.flipbook) {
                        try { state.flipbook.flip(currentPage); } catch(e){}
                    }
                } catch(err) {
                    console.error("Rotation Error:", err);
                } finally {
                    // 5. Force Loader OFF (Crucial Fix)
                    toggleLoader(false);
                }
            }, 500);
        });

        // --- ZOOM & TOUCH ---
        const view = el('zoom-viewport');
        let initialDistance = 0, initialScale = 1;

        window.manualZoom = (factor) => {
            state.scale *= factor;
            if(state.scale < 1) state.scale = 1;
            if(state.scale > 5) state.scale = 5;
            updateTransform();
        };

        function updateTransform() {
            view.style.transform = `scale(${state.scale})`;
        }

        // Pinch Zoom Logic
        view.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                initialDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                initialScale = state.scale;
                e.preventDefault();
            }
        }, { passive: false });

        view.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                const dist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                state.scale = initialScale * (dist / initialDistance);
                if(state.scale < 1) state.scale = 1;
                updateTransform();
                e.preventDefault();
            }
        }, { passive: false });

        // Nav
        el('prevBtn').onclick = () => state.flipbook.flipPrev();
        el('nextBtn').onclick = () => state.flipbook.flipNext();
        function toggleUrlModal(show) { el('urlModal').style.display = show ? 'flex' : 'none'; }
        function toggleLoader(show, text) { 
            const l = el('loader');
            if(show) { l.classList.remove('hidden'); el('loading-text').textContent = text; }
            else l.classList.add('hidden');
        }
    </script>
</body>
</html>
